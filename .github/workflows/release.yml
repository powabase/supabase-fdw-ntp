name: Release WASM FDW

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write  # Required for creating releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # Install Rust toolchain (modern approach - replaces actions-rs/toolchain)
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      # Cache cargo registry, git dependencies, and build artifacts
      # Saves 2-5 minutes on subsequent builds
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "wasm-release"
          cache-on-failure: true

      # Install cargo-component using pre-built binary (faster than cargo install)
      - name: Install cargo-component
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-component@0.21.1

      # Install wasm-tools for validation
      - name: Install wasm-tools
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-tools

      # Build optimized WASM binary
      - name: Build WASM binary
        run: |
          echo "Building WASM binary with target: wasm32-unknown-unknown"
          cargo component build --release --target wasm32-unknown-unknown
          ls -lh target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm

      # Validate WASM structure (CRITICAL: prevent WASI import bugs)
      - name: Validate WASM structure
        run: |
          echo "Validating WASM binary..."

          # Validate WASM is well-formed
          wasm-tools validate target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm

          # CRITICAL: Check for WASI CLI imports (should be ZERO)
          echo "Checking for WASI CLI imports (expecting: none)..."
          WASI_CLI_COUNT=$(wasm-tools component wit target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm | grep -c "wasi:cli" || echo "0")

          if [ "$WASI_CLI_COUNT" -gt 0 ]; then
            echo "âŒ ERROR: Found $WASI_CLI_COUNT WASI CLI imports!"
            echo "This means you built with wasm32-wasip1 instead of wasm32-unknown-unknown"
            echo "Supabase Wrappers doesn't provide WASI CLI interfaces - build will fail"
            wasm-tools component wit target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm | grep wasi:cli
            exit 1
          fi

          echo "âœ… WASM validation passed - zero WASI CLI imports"

          # Show imports for verification
          echo "WASM imports:"
          wasm-tools component wit target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm | head -15

      # Check binary size
      - name: Check binary size
        id: size
        run: |
          SIZE=$(stat -c%s target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm 2>/dev/null || stat -f%z target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm)
          SIZE_KB=$((SIZE / 1024))
          echo "size_kb=$SIZE_KB" >> $GITHUB_OUTPUT
          echo "Binary size: ${SIZE_KB} KB"

          if [ $SIZE_KB -gt 320 ]; then
            echo "âš ï¸  WARNING: Binary size ($SIZE_KB KB) is larger than expected"
            echo "Expected: ~301 KB. Check build optimizations in Cargo.toml"
          else
            echo "âœ… Binary size within expected range"
          fi

      # Calculate SHA256 checksum
      - name: Calculate SHA256 checksum
        id: checksum
        run: |
          cd target/wasm32-unknown-unknown/release

          # Calculate checksum (cross-platform)
          if command -v sha256sum > /dev/null; then
            CHECKSUM=$(sha256sum supabase_fdw_ntp.wasm | awk '{print $1}')
          else
            CHECKSUM=$(shasum -a 256 supabase_fdw_ntp.wasm | awk '{print $1}')
          fi

          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "$CHECKSUM  supabase_fdw_ntp.wasm" > supabase_fdw_ntp.wasm.sha256

          echo "SHA256 checksum: $CHECKSUM"

          # Also create checksums.txt for compatibility
          echo "SHA256 Checksums" > checksums.txt
          echo "================" >> checksums.txt
          echo "" >> checksums.txt
          echo "$CHECKSUM  supabase_fdw_ntp.wasm" >> checksums.txt

      # Get version from tag
      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      # Create GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm
            target/wasm32-unknown-unknown/release/supabase_fdw_ntp.wasm.sha256
            target/wasm32-unknown-unknown/release/checksums.txt
          generate_release_notes: true
          body: |
            ## NTP Energy Market WASM FDW ${{ steps.version.outputs.version }}

            **Binary:** ${{ steps.size.outputs.size_kb }} KB | **SHA256:** `${{ steps.checksum.outputs.checksum }}`

            ### Tables

            4 production-ready foreign tables for German energy market data:

            1. **renewable_energy_timeseries** - Solar and wind generation (9 endpoints, 10 columns)
            2. **electricity_market_prices** - Spot market, premiums, negative price indicators (4 endpoints, 5 columns)
            3. **redispatch_events** - Grid intervention events (1 endpoint, 9 columns)
            4. **grid_status_timeseries** - Minute-by-minute grid stability monitoring (1 endpoint, 3 columns)

            **Total:** 15 API endpoints consolidated into 4 queryable tables

            ---

            ### Quick Start

            ```sql
            -- Create foreign server with OAuth2 credentials
            CREATE SERVER ntp_server
              FOREIGN DATA WRAPPER wasm_wrapper
              OPTIONS (
                fdw_package_url 'https://github.com/powabase/supabase-fdw-ntp/releases/download/${{ steps.version.outputs.version }}/supabase_fdw_ntp.wasm',
                fdw_package_name 'powabase:supabase-fdw-ntp',
                fdw_package_version '${{ steps.version.outputs.version }}',
                fdw_package_checksum '${{ steps.checksum.outputs.checksum }}',
                api_base_url 'https://ds.netztransparenz.de',
                oauth2_token_url 'https://identity.netztransparenz.de/users/connect/token',
                oauth2_client_id 'YOUR_CLIENT_ID',
                oauth2_client_secret 'YOUR_CLIENT_SECRET',
                oauth2_scope 'ntpStatistic.read_all_public'
              );

            -- Create schema
            CREATE SCHEMA ntp;

            -- Example: Renewable Energy table
            CREATE FOREIGN TABLE ntp.renewable_energy_timeseries (
              timestamp_utc TIMESTAMPTZ NOT NULL,
              product_type TEXT NOT NULL,
              data_category TEXT NOT NULL,
              interval_minutes SMALLINT,
              tso_50hertz_mw DOUBLE PRECISION,
              tso_amprion_mw DOUBLE PRECISION,
              tso_tennet_mw DOUBLE PRECISION,
              tso_transnetbw_mw DOUBLE PRECISION,
              total_germany_mw DOUBLE PRECISION GENERATED ALWAYS AS (
                COALESCE(tso_50hertz_mw, 0) + COALESCE(tso_amprion_mw, 0) +
                COALESCE(tso_tennet_mw, 0) + COALESCE(tso_transnetbw_mw, 0)
              ) STORED,
              has_missing_data BOOLEAN GENERATED ALWAYS AS (
                tso_50hertz_mw IS NULL OR tso_amprion_mw IS NULL OR
                tso_tennet_mw IS NULL OR tso_transnetbw_mw IS NULL
              ) STORED
            )
            SERVER ntp_server
            OPTIONS (
              object 'renewable_energy_timeseries',
              product_type 'solar',
              data_category 'forecast'
            );

            -- Query example: Solar forecast for today
            SELECT
              timestamp_utc,
              total_germany_mw,
              tso_50hertz_mw,
              tso_amprion_mw
            FROM ntp.renewable_energy_timeseries
            WHERE product_type = 'solar'
              AND data_category = 'forecast'
              AND timestamp_utc >= CURRENT_DATE
            ORDER BY timestamp_utc
            LIMIT 24;
            ```

            **ðŸ“– Full Setup:** See [QUICKSTART.md](https://github.com/powabase/supabase-fdw-ntp/blob/main/QUICKSTART.md) for complete installation instructions and all 4 table schemas.

            ---

            ### Features

            - âœ… **15 API Endpoints** consolidated into 4 tables
            - âœ… **OAuth2 Authentication** with token caching (1-hour lifetime)
            - âœ… **German Locale Support** (CSV parsing, DD.MM.YYYY dates, comma decimals)
            - âœ… **Query Routing** - WHERE clause filters determine API endpoint selection
            - âœ… **11 ETL Transformations** for data normalization
            - âœ… **JOIN Support** - Full PostgreSQL JOIN capabilities validated
            - âœ… **Security Hardened** - 6 critical fixes (bounds checking, safe conversions, explicit errors)
            - âœ… **119 Unit Tests** - Comprehensive test coverage

            ---

            ### Documentation

            - **[README](https://github.com/powabase/supabase-fdw-ntp/blob/main/README.md)** - Project overview
            - **[QUICKSTART](https://github.com/powabase/supabase-fdw-ntp/blob/main/QUICKSTART.md)** - 5-minute setup guide
            - **[CLAUDE](https://github.com/powabase/supabase-fdw-ntp/blob/main/CLAUDE.md)** - Development guide with all patterns
            - **[Endpoint Docs](https://github.com/powabase/supabase-fdw-ntp/blob/main/docs/endpoints/README.md)** - All 4 tables with complete schemas
            - **[E2E Testing](https://github.com/powabase/supabase-fdw-ntp/blob/main/docs/guides/E2E_TESTING_GUIDE.md)** - Testing and validation guide
            - **[Architecture](https://github.com/powabase/supabase-fdw-ntp/blob/main/docs/reference/ARCHITECTURE.md)** - 15 ADRs and design decisions

            ---

            **Built with:** Rust 1.70+, cargo-component 0.21.1, wasm32-unknown-unknown | **Validated:** Zero WASI CLI imports âœ…
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
